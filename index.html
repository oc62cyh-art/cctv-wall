<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Denpasar ATCS Mobile</title>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg:#05070b;
  --tile:#050912;
  --text:#e9eefc;
  --gap:8px;
  --radius:14px;

  /* 6 tiles = 2 cols x 3 rows */
  --cols:2;
  --rows:3;

  /* reduce brightness a bit for daily use */
  --dim: 0.78;
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
body{overflow:hidden}

.hud{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:10px;
  padding:10px 10px 8px;
  background:rgba(0,0,0,.70);
  backdrop-filter: blur(10px);
}

.hud b{letter-spacing:.4px}
.spacer{flex:1}

.btn{
  background:rgba(255,255,255,.08);
  color:#fff;
  border:1px solid rgba(255,255,255,.18);
  border-radius:999px;
  padding:8px 12px;
  font-size:12px;
  line-height:1;
  white-space:nowrap;
  appearance:none;
}

.btn:active{transform:scale(.98)}

.pager{
  display:flex;align-items:center;gap:8px;
  font-size:12px;
  opacity:.9;
}

.grid{
  height:calc(100% - 54px);
  display:grid;
  grid-template-columns:repeat(var(--cols),1fr);
  grid-template-rows:repeat(var(--rows),1fr);
  gap:var(--gap);
  padding:10px;
}

.tile{
  position:relative;
  background:var(--tile);
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  touch-action: manipulation;
}

video{
  position:absolute;inset:0;
  width:100%;height:100%;
  object-fit:cover;
  background:#000;
  filter: brightness(var(--dim));
}

.badge{
  position:absolute;top:8px;right:8px;
  font-size:10px;font-weight:800;
  padding:3px 8px;border-radius:999px;
  letter-spacing:.3px;
  user-select:none;
  z-index:3;
}
.ok{background:#1faa59}
.restart{background:#f5a623;color:#111}
.bad{background:#e74c3c}

.sourceTag{
  position:absolute;top:8px;left:34px;
  font-size:10px;font-weight:800;
  padding:3px 8px;border-radius:999px;
  letter-spacing:.25px;
  user-select:none;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.12);
  z-index:3;
}

.pinMark{
  position:absolute;left:8px;top:8px;
  font-size:14px;
  text-shadow:0 2px 12px rgba(0,0,0,.6);
  user-select:none;
  z-index:3;
}

.nameTag{
  position:absolute;left:8px;bottom:8px;
  max-width: calc(100% - 16px);
  font-size:10px;
  padding:4px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.45);
  border:1px solid rgba(255,255,255,.10);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  z-index:3;
}

.stats{
  position:absolute;right:8px;bottom:8px;
  font-size:10px;
  padding:4px 7px;
  border-radius:10px;
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  opacity:.9;
  font-variant-numeric: tabular-nums;
  z-index:3;
}

/* Per-tile reload button */
.tileReload{
  position:absolute;
  right:8px;
  top:34px;
  z-index:4;
  width:30px;height:30px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.35);
  color:#fff;
  display:grid;
  place-items:center;
  font-size:14px;
  line-height:1;
  user-select:none;
}
.tileReload:active{transform:scale(.98)}
.tileReload:hover{background:rgba(0,0,0,.5)}

/* per-tile fullscreen */
.tile.fs{
  position:fixed;inset:0;z-index:9999;
  border-radius:0;
}
.tile.fs video{filter:none}
.tile.fs .nameTag,
.tile.fs .stats,
.tile.fs .pinMark,
.tile.fs .sourceTag,
.tile.fs .badge,
.tile.fs .tileReload{transform: scale(1.05); transform-origin: bottom right;}
</style>
</head>

<body>
  <div class="hud">
    <b>ATCS</b>

    <button class="btn" id="prevBtn">‚üµ Prev</button>
    <button class="btn" id="nextBtn">Next ‚ü∂</button>

    <div class="pager" id="pageInfo">Page 1/1</div>

    <div class="spacer"></div>

    <button class="btn" id="reloadBroken">ü©π Reload Broken</button>
  </div>

  <div class="grid" id="grid"></div>

<script>
/* ================= CONFIG ================= */
const PROXY = "https://denpasar-atcs-proxy.oc62cyh.workers.dev/hls?url=";
const PER_PAGE = 6;                 // 6 tiles on mobile
const STALL_MS = 15000;             // if no timeupdate for 15s => restart
const STATS_EVERY_MS = 2000;        // fps/lag update

/* ================= STREAMS ================= */
const STREAMS = [
  // --- ATCS (use proxy) ---
  { name: "A070 TITIBANDA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A070TITIBANDAPTZ/stream.m3u8" },
  { name: "A023 CATURMUKA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A023CATURMUKAPTZ/stream.m3u8" },
  { name: "A008 MAHENDRADATTA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A008MAHENDRADATTAPTZ/stream.m3u8" },
  { name: "A004 TEUKUUMAR PTZ2", url: "https://atcs.denpasarkota.go.id/stream/A004TEUKUUMARPTZ2/stream.m3u8" },
  { name: "A042 SEDAPMALAM PTZ", url: "https://atcs.denpasarkota.go.id/stream/A042SEDAPMALAMPTZ/stream.m3u8" },
  { name: "A043 GUNUNGGALUNGGUNG PTZ", url: "https://atcs.denpasarkota.go.id/stream/A043GUNUNGGALUNGGUNGPTZ/stream.m3u8" },
  { name: "A031 PIDADA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A031PIDADAPTZ/stream.m3u8" },
  { name: "A001 GUNUNGAGUNG PTZ", url: "https://atcs.denpasarkota.go.id/stream/A001GUNUNGAGUNGPTZ/stream.m3u8" },
  { name: "A032 AHMADYANI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A032AHMADYANIPTZ/stream.m3u8" },
  { name: "A033 NANGKA PTZ1", url: "https://atcs.denpasarkota.go.id/stream/A033NANGKAPTZ1/stream.m3u8" },
  { name: "A063 PANTAI MATAHARI TERBIT PTZ", url: "https://atcs.denpasarkota.go.id/stream/A063PANTAIMATAHARITERBITPTZ/stream.m3u8" },
  { name: "A071 BUNDARAN HANG TUAH PTZ", url: "https://atcs.denpasarkota.go.id/stream/A071BUNDARANHANGTUAHPTZ/stream.m3u8" },
  { name: "A022 UBUNG PTZ1", url: "https://atcs.denpasarkota.go.id/stream/A022UBUNGPTZ1/stream.m3u8" },
  { name: "A016 YOSSUDARSO PTZ", url: "https://atcs.denpasarkota.go.id/stream/A016YOSSUDARSOPTZ/stream.m3u8" },
  { name: "A030 CARGO PTZ", url: "https://atcs.denpasarkota.go.id/stream/A030CARGOPTZ/stream.m3u8" },
  { name: "A034 KENYERI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A034KENYERIPTZ/stream.m3u8" },

  { name: "A115 ANTASURA PANORAMIC", url: "https://atcs.denpasarkota.go.id/stream/A115ANTASURAPANORAMIC/stream.m3u8" },
  { name: "A073 AHMADYANI - MARUTI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A073AHMADYANI-MARUTIPTZ/stream.m3u8" },
  { name: "A093 DPRD KOTA DENPASAR PTZ", url: "https://atcs.denpasarkota.go.id/stream/A093DPRDKOTADENPASARPTZ/stream.m3u8" },
  { name: "A116 PEMOGAN PTZ", url: "https://atcs.denpasarkota.go.id/stream/A116PEMOGANPTZ/stream.m3u8" },
  { name: "A103 GAJAH BADA BARAT PANORAMIC", url: "https://atcs.denpasarkota.go.id/stream/A103GAJAHBADABARATPANORAMIC/stream.m3u8" },
  { name: "A066 PUPUTAN PTZ", url: "https://atcs.denpasarkota.go.id/stream/A066PUPUTANPTZ/stream.m3u8" },
  { name: "A074 AHMADYANI - MULAWARMAN PANORAMIC", url: "https://atcs.denpasarkota.go.id/stream/A074AHMADYANI-MULAWARMANPANORAMIC/stream.m3u8" },
  { name: "A114 SURADIPA PANORAMIC", url: "https://atcs.denpasarkota.go.id/stream/A114SURADIPAPANORAMIC/stream.m3u8" },
  { name: "A048 NUSA INDAH PTZ", url: "https://atcs.denpasarkota.go.id/stream/A048NUSAINDAHPTZ/stream.m3u8" },
  { name: "A037 KENAROK PTZ", url: "https://atcs.denpasarkota.go.id/stream/A037KENAROKPTZ/stream.m3u8" },
  { name: "A038 TOHPATI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A038TOHPATIPTZ/stream.m3u8" },
  { name: "A039 KEBO IWA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A039KEBOIWAPTZ/stream.m3u8" },
  { name: "A040 SEKAR SARI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A040SEKARSARIPTZ/stream.m3u8" },
  { name: "A041 GEMITIR PTZ", url: "https://atcs.denpasarkota.go.id/stream/A041GEMITIRPTZ/stream.m3u8" },
  { name: "A035 NOJA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A035NOJAPTZ/stream.m3u8" },
  { name: "A036 TRENGGULI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A036TRENGGULIPTZ/stream.m3u8" },
  { name: "A024 ARJUNA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A024ARJUNAPTZ/stream.m3u8" },
  { name: "A017 PUPUTAN PTZ (ALT)", url: "https://atcs.denpasarkota.go.id/stream/A017PUPUTANPTZ/stream.m3u8" },
  { name: "A014 KAPTEN JAPA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A014KAPTENJAPAPTZ/stream.m3u8" },
  { name: "A013 SIDAKARYA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A013SIDAKARYAPTZ/stream.m3u8" },
  { name: "A012 PULAU SAELUS PTZ", url: "https://atcs.denpasarkota.go.id/stream/A012PULAUSAELUSPTZ/stream.m3u8" },
  { name: "A011 MERPATI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A011MERPATIPTZ/stream.m3u8" },
  { name: "A007 BALUN PTZ", url: "https://atcs.denpasarkota.go.id/stream/A007BALUNPTZ/stream.m3u8" },
  { name: "A005 BATANTA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A005BATANTAPTZ/stream.m3u8" },
  { name: "TEUKU UMAR PTZ1", url: "https://atcs.denpasarkota.go.id/stream/TEUKUUMARPTZ1/stream.m3u8" },
  { name: "A003 GUNUNG SALAK PTZ", url: "https://atcs.denpasarkota.go.id/stream/A003GUNUNGSALAKPTZ/stream.m3u8" },

  // --- BaliProv (direct HLS) ---
  { name: "BaliProv: perbatasan-klungkung-gianyar", url: "https://transcode.baliprov.go.id/cctv/perbatasan-klungkung-gianyar/video1_stream.m3u8" },
  { name: "BaliProv: terminal-cargo", url: "https://transcode.baliprov.go.id/cctv/terminal-cargo/video1_stream.m3u8" },
  { name: "BaliProv: catus-pata", url: "https://transcode.baliprov.go.id/cctv/catus-pata/video1_stream.m3u8" },
  { name: "BaliProv: perempatan-banjarangkan-tusan", url: "https://transcode.baliprov.go.id/cctv/perempatan-banjarangkan-tusan/video1_stream.m3u8" },
  { name: "BaliProv: perempatan-sudirman", url: "https://transcode.baliprov.go.id/cctv/perempatan-sudirman/video1_stream.m3u8" },
  { name: "BaliProv: patih-jelantik-majapahit", url: "https://transcode.baliprov.go.id/cctv/patih-jelantik-majapahit/video1_stream.m3u8" },
  { name: "BaliProv: jalan-seminyak-bintanggg-keraton", url: "https://transcode.baliprov.go.id/cctv/jalan-seminyak-depan-swalayan-bintanggg-keraton/video1_stream.m3u8" },
  { name: "BaliProv: jl-arjuna-doublesix", url: "https://transcode.baliprov.go.id/cctv/jl-arjuna-parkiran-pantai-doublesix/video1_stream.m3u8" },
  { name: "BaliProv: depan-pura-goa-lawah", url: "https://transcode.baliprov.go.id/cctv/depan-pura-goa-lawah/video1_stream.m3u8" },
  { name: "BaliProv: pertigaan-sman-satu-semarapura", url: "https://transcode.baliprov.go.id/cctv/pertigaan-sman-satu-semarapura/video1_stream.m3u8" },
  { name: "BaliProv: simpang-lima", url: "https://transcode.baliprov.go.id/cctv/simpang-lima/video1_stream.m3u8" },
  { name: "BaliProv: pasar-senggol", url: "https://transcode.baliprov.go.id/cctv/pasar-senggol/video1_stream.m3u8" },
  { name: "BaliProv: depan-popies-2--sky-garden", url: "https://transcode.baliprov.go.id/cctv/depan-popies-2--sky-garden/video1_stream.m3u8" },
  { name: "BaliProv: simpang-bali-beach", url: "https://transcode.baliprov.go.id/cctv/simpang-bali-beach/video1_stream.m3u8" },
  { name: "BaliProv: simpang-padang-galak", url: "https://transcode.baliprov.go.id/cctv/simpang-padang-galak/video1_stream.m3u8" },

];

/* ================= HELPERS ================= */
function camNum(name){
  const m = String(name).match(/\bA(\d{3})\b/i);
  return m ? parseInt(m[1],10) : 999999;
}
function isATCS(url){ return /atcs\.denpasarkota\.go\.id/i.test(url); }
function sourceLabel(url){ return isATCS(url) ? "ATCS" : "BaliProv"; }

/* Sort ATCS first by A###, then BaliProv */
STREAMS.sort((a,b)=>{
  const aa = isATCS(a.url), bb = isATCS(b.url);
  if (aa && !bb) return -1;
  if (!aa && bb) return 1;
  const na = camNum(a.name), nb = camNum(b.name);
  if (na !== nb) return na - nb;
  return a.name.localeCompare(b.name);
});

/* ================= PIN LOGIC (toggle) ================= */
let pinnedUrl = localStorage.getItem("pin_url") || "";
function setPinned(url){
  if (!url){
    localStorage.removeItem("pin_url");
    pinnedUrl = "";
  } else {
    localStorage.setItem("pin_url", url);
    pinnedUrl = url;
  }
}
function orderedStreams(){
  if (!pinnedUrl) return STREAMS.slice();
  const pinned = STREAMS.find(s=>s.url===pinnedUrl);
  const rest = STREAMS.filter(s=>s.url!==pinnedUrl);
  return pinned ? [pinned, ...rest] : STREAMS.slice();
}

/* ================= PAGING ================= */
let pageIndex = 0;
function totalPages(list){
  return Math.max(1, Math.ceil(list.length / PER_PAGE));
}
function clampPage(i, list){
  const tp = totalPages(list);
  return ((i % tp) + tp) % tp;
}
function updatePageInfo(list){
  document.getElementById("pageInfo").textContent = `Page ${pageIndex+1}/${totalPages(list)}`;
}

/* ================= TILE PLAYER ================= */
const grid = document.getElementById("grid");
let currentTiles = [];

function cleanupAllTiles(){
  currentTiles.forEach(ref => {
    try{
      if (ref.statsTimer) clearInterval(ref.statsTimer);
      if (ref.hls){ try{ref.hls.destroy();}catch(e){} ref.hls = null; }
      if (ref.video){
        try{ ref.video.pause(); }catch(e){}
        ref.video.removeAttribute("src");
        ref.video.load();
      }
    }catch(e){}
  });
  currentTiles = [];
}

function makePlayableUrl(camUrl){
  if (isATCS(camUrl)) return PROXY + encodeURIComponent(camUrl);
  return camUrl;
}

function renderPage(){
  const list = orderedStreams();
  pageIndex = clampPage(pageIndex, list);
  updatePageInfo(list);

  cleanupAllTiles();
  grid.innerHTML = "";

  const start = pageIndex * PER_PAGE;
  const pageItems = list.slice(start, start + PER_PAGE);

  pageItems.forEach((cam) => {
    const tile = document.createElement("div");
    tile.className = "tile";

    const v = document.createElement("video");
    v.muted = true;
    v.autoplay = true;
    v.playsInline = true;
    v.controls = false;

    const badge = document.createElement("div");
    badge.className = "badge restart";
    badge.textContent = "START";

    const pin = document.createElement("div");
    pin.className = "pinMark";
    if (cam.url === pinnedUrl) pin.textContent = "üìå";

    const srcTag = document.createElement("div");
    srcTag.className = "sourceTag";
    srcTag.textContent = sourceLabel(cam.url);

    const reloadBtn = document.createElement("div");
    reloadBtn.className = "tileReload";
    reloadBtn.title = "Reload this tile";
    reloadBtn.textContent = "‚Üª";

    const nameTag = document.createElement("div");
    nameTag.className = "nameTag";
    nameTag.textContent = cam.name;

    const stats = document.createElement("div");
    stats.className = "stats";
    stats.textContent = "0fps 0.0s";

    tile.append(v, badge, pin, srcTag, reloadBtn, nameTag, stats);
    grid.appendChild(tile);

    const baseSrc = makePlayableUrl(cam.url);

    let hls = null;
    let lastUpdate = Date.now();
    let frames = 0;
    let restarting = false;

    function setBadge(state){
      if (state === "ok"){
        badge.className = "badge ok"; badge.textContent = "OK";
      } else if (state === "bad"){
        badge.className = "badge bad"; badge.textContent = "STALLED";
      } else {
        badge.className = "badge restart"; badge.textContent = "RESTART";
      }
    }

    function startPlayback(){
      restarting = true;
      setBadge("restart");

      if (hls){ try{ hls.destroy(); }catch(e){} hls=null; }
      try{ v.pause(); }catch(e){}
      v.removeAttribute("src");
      v.load();

      const urlWithTs = baseSrc + (baseSrc.includes("?") ? "&" : "?") + "t=" + Date.now();

      if (v.canPlayType("application/vnd.apple.mpegurl")){
        v.src = urlWithTs;
        v.play().catch(()=>{});
      } else if (window.Hls && Hls.isSupported()){
        hls = new Hls({
          lowLatencyMode: true,
          backBufferLength: 30,
          maxLiveSyncPlaybackRate: 1.5
        });
        hls.attachMedia(v);
        hls.on(Hls.Events.MEDIA_ATTACHED, () => hls.loadSource(urlWithTs));
        hls.on(Hls.Events.ERROR, (_, data) => {
          if (data && data.fatal){
            setBadge("bad");
            setTimeout(() => startPlayback(), 1200);
          }
        });
      } else {
        setBadge("bad");
      }

      v.play().catch(()=>{});
      setTimeout(()=>{ restarting=false; }, 800);
    }

    v.addEventListener("timeupdate", () => {
      lastUpdate = Date.now();
      frames++;
      if (!restarting) setBadge("ok");
    });

    const statsTimer = setInterval(() => {
      const fps = Math.round(frames / (STATS_EVERY_MS / 1000));
      frames = 0;

      const lag = (Date.now() - lastUpdate) / 1000;
      stats.textContent = `${fps}fps ${lag.toFixed(1)}s`;

      if (lag * 1000 > STALL_MS){
        setBadge("bad");
        startPlayback();
      }
    }, STATS_EVERY_MS);

    // Per-tile reload button (do not toggle fullscreen)
    reloadBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      startPlayback();
    });

    // tap: fullscreen toggle
    tile.addEventListener("click", () => {
      tile.classList.toggle("fs");
    });

    // long-press: PIN / UNPIN toggle
    let pressTimer = null;
    const pressStart = () => {
      pressTimer = setTimeout(() => {
        if (pinnedUrl === cam.url){
          // unpin
          setPinned("");
        } else {
          // pin
          setPinned(cam.url);
        }
        pageIndex = 0;
        renderPage();
      }, 650);
    };
    const pressEnd = () => {
      if (pressTimer) clearTimeout(pressTimer);
      pressTimer = null;
    };

    tile.addEventListener("touchstart", pressStart, {passive:true});
    tile.addEventListener("touchend", pressEnd);
    tile.addEventListener("touchcancel", pressEnd);

    // start now
    startPlayback();

    currentTiles.push({
      tile,
      video: v,
      statsTimer,
      get hls(){ return hls; },
      set hls(val){ hls = val; },
      restartFn: startPlayback,
      isBadFn: () => badge.classList.contains("bad") || badge.textContent === "STALLED"
    });
  });
}

/* ================= CONTROLS ================= */
document.getElementById("prevBtn").onclick = () => { pageIndex--; renderPage(); };
document.getElementById("nextBtn").onclick = () => { pageIndex++; renderPage(); };

document.getElementById("reloadBroken").onclick = () => {
  currentTiles.forEach(t => { if (t.isBadFn()) t.restartFn(); });
};

/* swipe paging */
let x0 = null;
document.addEventListener("touchstart", (e)=>{ x0 = e.touches[0].clientX; }, {passive:true});
document.addEventListener("touchend", (e)=>{
  if (x0 == null) return;
  const x1 = (e.changedTouches && e.changedTouches[0]) ? e.changedTouches[0].clientX : x0;
  const dx = x1 - x0;
  x0 = null;
  if (Math.abs(dx) > 70){
    pageIndex += (dx < 0) ? 1 : -1;
    renderPage();
  }
}, {passive:true});

/* ================= START ================= */
renderPage();
</script>
</body>
</html>
