<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Denpasar ATCS Wall</title>

  <!-- HLS.js for Chrome/Edge/Firefox (Safari plays HLS natively) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

  <style>
    :root{
      --bg:#05070b; --tile:#050912; --divider: rgba(80, 220, 120, .35); --divider2: rgba(255,255,255,.08);
      --text:#e9eefc; --overlay: rgba(0,0,0,.55); --shadow: 0 18px 50px rgba(0,0,0,.55);
      --cols:4; --rows:4; --gap:6px; --radius:10px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:var(--font);}
    body{overflow:hidden;}

    body.tv .hud{display:none;}
    body.tv #wall{padding:0;}
    body.tv .frame{border-radius:0;}
    body.tv .bezel{inset:0; padding:10px;}

    #wall{
      height:100%; width:100%; padding:14px;
      display:flex; justify-content:center; align-items:stretch;
      background:
        radial-gradient(1000px 700px at 20% 15%, rgba(25,55,130,.25), transparent 55%),
        radial-gradient(800px 600px at 80% 25%, rgba(25,130,85,.15), transparent 55%),
        linear-gradient(180deg, #05070b 0%, #04060a 100%);
    }
    .frame{
      width:min(1600px, 100%); height:100%;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    .bezel{
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      padding:10px;
      display:flex; flex-direction:column; gap:10px;
    }

    .hud{
      position:absolute; top:16px; left:16px;
      display:flex; gap:8px; align-items:center;
      padding:8px 10px;
      border-radius:999px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      z-index:50; user-select:none;
    }
    .hud input{width:180px; border:0; outline:none; background:transparent; color:var(--text); font-size:12px;}
    .btn{
      border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); color: var(--text);
      padding:6px 9px; border-radius:999px; cursor:pointer; font-size:12px; white-space:nowrap;
    }
    .btn:hover{border-color: rgba(80,220,120,.45); box-shadow: 0 0 0 3px rgba(80,220,120,.12);}
    .meta{font-size:12px; opacity:.8; margin-left:6px; white-space:nowrap;}

    .grid{
      flex:1; min-height:0;
      display:grid;
      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
      grid-template-rows: repeat(var(--rows), minmax(0, 1fr));
      gap: var(--gap);
      padding:2px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      overflow:hidden;
    }
    .tile{
      position:relative;
      background:var(--tile);
      border:1px solid var(--divider2);
      outline:1px solid rgba(0,0,0,.45);
      border-radius:var(--radius);
      overflow:hidden;
    }
    .tile::after{
      content:"";
      position:absolute; inset:-1px;
      border-radius:var(--radius);
      pointer-events:none;
      box-shadow: 0 0 0 1px var(--divider);
      opacity:.55;
    }

    video{
      position:absolute; inset:0;
      width:100%; height:100%;
      object-fit: cover;
      background:#000;
    }

    .topbar,.bottombar{
      position:absolute; left:0; right:0;
      padding:6px 8px;
      display:flex; align-items:center; gap:8px;
      font-size:11px; letter-spacing:.2px; text-transform:uppercase;
      color: rgba(255,255,255,.92);
      text-shadow: 0 2px 8px rgba(0,0,0,.75);
      z-index:10; pointer-events:none;
    }
    .topbar{top:0; background: linear-gradient(180deg, var(--overlay), rgba(0,0,0,0));}
    .bottombar{bottom:0; justify-content:space-between; background: linear-gradient(0deg, var(--overlay), rgba(0,0,0,0));}
    .loc{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:82%;}
    .live{display:inline-flex; align-items:center; gap:6px; font-weight:700;}
    .dot{width:6px; height:6px; border-radius:999px; background:#ff3b3b; box-shadow:0 0 0 3px rgba(255,59,59,.18);}
    .stamp{font-variant-numeric: tabular-nums; color: rgba(255,255,255,.85);}

    .err{
      position:absolute; inset:0;
      display:none;
      place-items:center;
      text-align:center;
      padding: 14px;
      background: rgba(0,0,0,.55);
      z-index: 20;
      color: rgba(233,238,252,.88);
      font-size: 12px;
    }
    .err b{display:block; margin-bottom:6px; font-size:13px;}
    .tile.bad .err{display:grid;}

    .watermark{
      position:absolute; right:16px; bottom:16px;
      z-index:60;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:14px;
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(10px);
      opacity:.9;
      user-select:none;
    }
    .wm-logo{
      width:34px; height:34px; border-radius:10px;
      background: rgba(255,255,255,.10);
      display:grid; place-items:center; overflow:hidden;
    }
    .wm-logo img{width:100%; height:100%; object-fit:cover; display:block;}
    .wm-text{display:flex; flex-direction:column; gap:2px; line-height:1.1}
    .wm-text b{font-size:12px; letter-spacing:.3px}
    .wm-text small{font-size:11px; opacity:.75}

    .fsPrompt{
      position:absolute; inset:0; z-index:100;
      display:none; align-items:center; justify-content:center; padding:18px;
      background: radial-gradient(900px 600px at 50% 40%, rgba(0,0,0,.35), rgba(0,0,0,.85));
      backdrop-filter: blur(6px);
    }
    body.tv .fsPrompt{display:flex;}
    .fsCard{
      width:min(760px,92vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      box-shadow: 0 18px 60px rgba(0,0,0,.65);
      padding:18px 18px 16px;
      text-align:center;
    }
    .fsCard h1{margin:0 0 8px; font-size:18px;}
    .fsCard p{margin:0 0 14px; font-size:13px; color: rgba(233,238,252,.78); line-height:1.4}
    .fsRow{display:flex; gap:10px; justify-content:center; flex-wrap:wrap;}
    .bigBtn{
      border:1px solid rgba(80,220,120,.40);
      background: rgba(80,220,120,.14);
      color: var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      font-weight:700;
    }
    .ghostBtn{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
    }
    .warn{margin-top:10px; font-size:12px; color: rgba(233,238,252,.65);}
  </style>
</head>

<body>
<div id="wall">
  <div class="frame" id="frame">
    <div class="fsPrompt" id="fsPrompt">
      <div class="fsCard">
        <h1>â›¶ Click to enter Fullscreen</h1>
        <p>This TV Wall works best in fullscreen. If it doesnâ€™t enter fullscreen, try <b>F11</b> (Windows) or <b>Ctrl+âŒ˜+F</b> (Mac).</p>
        <div class="fsRow">
          <button class="bigBtn" id="enterFs">ENTER FULLSCREEN</button>
          <button class="ghostBtn" id="continueNoFs">Continue</button>
        </div>
        <div class="warn" id="fsStatus"></div>
      </div>
    </div>

    <div class="hud">
      ðŸ”Ž <input id="search" placeholder="Search (optional)â€¦" />
      <button class="btn" id="prev">âŸµ Prev</button>
      <button class="btn" id="next">Next âŸ¶</button>
      <button class="btn" id="enableRotate">â–¶ Enable rotate</button>
      <button class="btn" id="reloadAll">â†» Reload</button>
      <button class="btn" id="fullscreenWall">â›¶ Fullscreen</button>
      <button class="btn" id="tvMode">ðŸ“º TV Wall</button>
      <span class="meta" id="meta"></span>
    </div>

    <div class="watermark">
      <div class="wm-logo" id="wmLogo"></div>
      <div class="wm-text">
        <b id="wmTitle">DENPASAR ATCS WALL</b>
        <small id="wmOperator">Operator: Bima</small>
      </div>
    </div>

    <div class="bezel">
      <div class="grid" id="grid"></div>
    </div>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const OPERATOR_NAME = "Bima";
  const WATERMARK_TITLE = "DENPASAR ATCS WALL";
  const LOGO_URL = ""; // put a PNG/JPG url if you want

  const ROTATE_SECONDS = 20;       // rotation interval (only when enabled manually)
  const TILE_COUNT = 16;           // locked 4x4

  // Your Cloudflare Worker proxy (must end with /hls?url=)
  const PROXY = "https://denpasar-atcs-proxy.oc62cyh.workers.dev/hls?url=";

  // Source cameras (direct m3u8). Proxy will wrap these automatically.
  const STREAMS = [
    { name: "A070 TITIBANDA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A070TITIBANDAPTZ/stream.m3u8" },
    { name: "A023 CATURMUKA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A023CATURMUKAPTZ/stream.m3u8" },
    { name: "A008 MAHENDRADATTA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A008MAHENDRADATTAPTZ/stream.m3u8" },
    { name: "A004 TEUKUUMAR PTZ2", url: "https://atcs.denpasarkota.go.id/stream/A004TEUKUUMARPTZ2/stream.m3u8" },
    { name: "A042 SEDAPMALAM PTZ", url: "https://atcs.denpasarkota.go.id/stream/A042SEDAPMALAMPTZ/stream.m3u8" },
    { name: "A043 GUNUNGGALUNGGUNG PTZ", url: "https://atcs.denpasarkota.go.id/stream/A043GUNUNGGALUNGGUNGPTZ/stream.m3u8" },
    { name: "A031 PIDADA PTZ", url: "https://atcs.denpasarkota.go.id/stream/A031PIDADAPTZ/stream.m3u8" },
    { name: "A001 GUNUNGAGUNG PTZ", url: "https://atcs.denpasarkota.go.id/stream/A001GUNUNGAGUNGPTZ/stream.m3u8" },
    { name: "A032 AHMADYANI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A032AHMADYANIPTZ/stream.m3u8" },
    { name: "A033 NANGKA PTZ1", url: "https://atcs.denpasarkota.go.id/stream/A033NANGKAPTZ1/stream.m3u8" },
    { name: "A063 PANTAI MATAHARI TERBIT PTZ", url: "https://atcs.denpasarkota.go.id/stream/A063PANTAIMATAHARITERBITPTZ/stream.m3u8" },
    { name: "A071 BUNDARAN HANG TUAH PTZ", url: "https://atcs.denpasarkota.go.id/stream/A071BUNDARANHANGTUAHPTZ/stream.m3u8" },
    { name: "A022 UBUNG PTZ1", url: "https://atcs.denpasarkota.go.id/stream/A022UBUNGPTZ1/stream.m3u8" },
    { name: "A016 YOSSUDARSO PTZ", url: "https://atcs.denpasarkota.go.id/stream/A016YOSSUDARSOPTZ/stream.m3u8" },
    { name: "A030 CARGO PTZ", url: "https://atcs.denpasarkota.go.id/stream/A030CARGOPTZ/stream.m3u8" },
    { name: "A034 KENYERI PTZ", url: "https://atcs.denpasarkota.go.id/stream/A034KENYERIPTZ/stream.m3u8" }
  ];

  // ===== MODE =====
  const params = new URLSearchParams(location.search);
  const isTV = params.get("tv") === "1";
  if (isTV) document.body.classList.add("tv");
  const isEmbedded = (window.self !== window.top);

  // ===== HELPERS =====
  const pad = n => String(n).padStart(2,"0");
  function stamp(){
    const d = new Date();
    return `${pad(d.getDate())}-${pad(d.getMonth()+1)}-${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  // ===== WATERMARK =====
  document.getElementById("wmTitle").textContent = WATERMARK_TITLE;
  document.getElementById("wmOperator").textContent = `Operator: ${OPERATOR_NAME}`;
  const wmLogo = document.getElementById("wmLogo");
  if (LOGO_URL){
    const img = document.createElement("img");
    img.src = LOGO_URL; img.alt="Logo";
    wmLogo.appendChild(img);
  } else {
    wmLogo.textContent = "ðŸš¦";
    wmLogo.style.fontSize = "18px";
  }

  // ===== STREAM LIST (wrapped through proxy) =====
  const allCams = STREAMS.map(s => ({
    label: s.name,
    url: PROXY + encodeURIComponent(s.url),
    search: (s.name + " " + s.url).toLowerCase()
  }));

  // ===== BUILD TILES =====
  const grid = document.getElementById("grid");
  const tiles = [];

  function createTile(){
    const tile = document.createElement("div");
    tile.className = "tile";

    const video = document.createElement("video");
    video.muted = true;
    video.autoplay = true;
    video.playsInline = true;
    video.controls = false;

    const topbar = document.createElement("div");
    topbar.className = "topbar";
    topbar.innerHTML = `<span class="loc">â€”</span>`;

    const bottombar = document.createElement("div");
    bottombar.className = "bottombar";
    bottombar.innerHTML = `
      <span class="live"><span class="dot"></span> LIVE</span>
      <span class="stamp" data-stamp="1">${stamp()}</span>
    `;

    const err = document.createElement("div");
    err.className = "err";
    err.innerHTML = `<div><b>Stream not playing</b><div class="msg">Click once to allow autoplay, or stream is offline.</div></div>`;

    tile.append(video, topbar, bottombar, err);

    tile._video = video;
    tile._hls = null;
    tile._locEl = topbar.querySelector(".loc");
    tile._setError = (msg) => {
      tile.classList.add("bad");
      tile.querySelector(".msg").textContent = msg || "Stream error";
    };
    tile._clearError = () => tile.classList.remove("bad");

    return tile;
  }

  for (let i=0; i<TILE_COUNT; i++){
    const t = createTile();
    tiles.push(t);
    grid.appendChild(t);
  }

  function destroyHls(tile){
    if (tile._hls){
      try { tile._hls.destroy(); } catch(e) {}
      tile._hls = null;
    }
  }

  function playOnTile(tile, url){
    tile._clearError();
    destroyHls(tile);

    const video = tile._video;
    video.pause();
    video.removeAttribute("src");
    video.load();

    // Safari can play HLS natively
    if (video.canPlayType("application/vnd.apple.mpegurl")){
      video.src = url;
      video.play().catch(() => tile._setError("Autoplay blocked â€” click once on the page."));
      return;
    }

    // Chrome/Edge/Firefox via hls.js
    if (window.Hls && Hls.isSupported()){
      const hls = new Hls({ lowLatencyMode: true, backBufferLength: 30 });
      tile._hls = hls;

      hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED, () => hls.loadSource(url));
      hls.on(Hls.Events.ERROR, (evt, data) => {
        if (data && data.fatal) {
          tile._setError(`HLS fatal: ${data.type}`);
          try { hls.destroy(); } catch(e) {}
          tile._hls = null;
        }
      });

      video.play().catch(() => tile._setError("Autoplay blocked â€” click once on the page."));
      return;
    }

    tile._setError("HLS not supported in this browser");
  }

  // ===== PAGING (manual by default) =====
  let filtered = allCams.slice();
  let pageIndex = 0;

  function pageCount(){ return Math.max(1, Math.ceil(filtered.length / TILE_COUNT)); }
  function updateMeta(){
    document.getElementById("meta").textContent = `Page ${pageIndex+1}/${pageCount()} â€¢ ${filtered.length} cams`;
  }

  function setPage(idx){
    const pc = pageCount();
    pageIndex = ((idx % pc) + pc) % pc;
    const start = pageIndex * TILE_COUNT;

    for (let i=0; i<TILE_COUNT; i++){
      const cam = filtered[start + i];
      const tile = tiles[i];

      if (cam){
        tile.style.visibility = "visible";
        tile._locEl.textContent = cam.label;
        tile._locEl.title = cam.url;
        playOnTile(tile, cam.url);
      } else {
        tile.style.visibility = "hidden";
        destroyHls(tile);
        tile._video.removeAttribute("src");
        tile._video.load();
        tile._locEl.textContent = "â€”";
        tile._locEl.title = "";
      }
    }
    updateMeta();
  }

  document.getElementById("prev").onclick = () => setPage(pageIndex - 1);
  document.getElementById("next").onclick = () => setPage(pageIndex + 1);
  document.getElementById("reloadAll").onclick = () => setPage(pageIndex);

  document.getElementById("search").addEventListener("input", (e) => {
    const q = e.target.value.trim().toLowerCase();
    filtered = q ? allCams.filter(c => c.search.includes(q)) : allCams.slice();
    pageIndex = 0;
    setPage(0);
  });

  // ===== FULLSCREEN =====
  async function requestFull(){
    try { await document.getElementById("frame").requestFullscreen(); return true; }
    catch { return false; }
  }

  document.getElementById("fullscreenWall").onclick = async () => {
    if (isEmbedded){
      const tvUrl = new URL(location.href);
      tvUrl.searchParams.set("tv","1");
      window.open(tvUrl.toString(), "_blank", "noopener,noreferrer");
      return;
    }
    await requestFull();
  };

  document.getElementById("tvMode").onclick = () => {
    const tvUrl = new URL(location.href);
    tvUrl.searchParams.set("tv","1");
    window.open(tvUrl.toString(), "_blank", "noopener,noreferrer");
  };

  // ===== OPTIONAL ROTATE (manual enable) =====
  let rotating = false;
  let rotateTimer = null;
  const rotateBtn = document.getElementById("enableRotate");

  function stopRotate(){
    rotating = false;
    if (rotateTimer) clearInterval(rotateTimer);
    rotateTimer = null;
    rotateBtn.textContent = "â–¶ Enable rotate";
  }
  function startRotate(){
    rotating = true;
    rotateBtn.textContent = "â¸ Stop rotate";
    if (rotateTimer) clearInterval(rotateTimer);
    rotateTimer = setInterval(() => setPage(pageIndex + 1), ROTATE_SECONDS * 1000);
  }
  rotateBtn.onclick = () => rotating ? stopRotate() : startRotate();
  stopRotate();

  // Clock
  setInterval(() => {
    const s = stamp();
    document.querySelectorAll('[data-stamp="1"]').forEach(el => el.textContent = s);
  }, 1000);

  // TV prompt
  const fsPrompt = document.getElementById("fsPrompt");
  const fsStatus = document.getElementById("fsStatus");
  const enterFs = document.getElementById("enterFs");
  const continueNoFs = document.getElementById("continueNoFs");
  function hidePrompt(){ fsPrompt.style.display = "none"; }

  if (isTV){
    fsPrompt.style.display = "flex";
    enterFs.addEventListener("click", async () => {
      const ok = await requestFull();
      if (ok) hidePrompt();
      else fsStatus.textContent = "Fullscreen blocked. Try F11 (Windows) or allow fullscreen permission.";
    });
    continueNoFs.addEventListener("click", hidePrompt);
    document.addEventListener("fullscreenchange", () => {
      if (document.fullscreenElement) hidePrompt();
    });
  } else {
    fsPrompt.style.display = "none";
  }

  // Start
  setPage(0);
</script>
</body>
</html>
